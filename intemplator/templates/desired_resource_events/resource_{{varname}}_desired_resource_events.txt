namespace = {{varname}}_desired_resource_events

country_event = {
	id = {{varname}}_desired_resource_events.1
	hide_window = yes
	is_triggered_only = no

	mean_time_to_happen = {
		days = 30
	}

	trigger = {
		has_modifier = politics
	}

	immediate = {
		# Get the current production
		export_resource_income_to_variable = {
			resource = {{varname}}_desired_value_change
			variable = current_{{varname}}_desired_value_change
		}

		# Define new desired point
		set_variable = {
			which = {{varname}}_new_desired_value
			value = {{baseValue}}
		}
		change_variable = {
			which = {{varname}}_new_desired_value
			value = current_{{varname}}_desired_value_change
		}

		# Clamp desired value to 0 inclusive to {{maxValue}} inclusive
		if = {
			limit = {
				check_variable = {
					which = {{varname}}_new_desired_value
					value > {{maxValue}}
				}
			}
			set_variable = {
				which = {{varname}}_new_desired_value
				value = {{maxValue}}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = {{varname}}_new_desired_value
					value < 0
				}
			}
			set_variable = {
				which = {{varname}}_new_desired_value
				value = 0
			}
		}
		# {{varname}}_new_desired_value is now the new desired point
		
		# Old desired value
		export_resource_stockpile_to_variable = {
			resource = {{varname}}_desired_value
			variable = current_{{varname}}_desired_value
		}

		# Determine the delta needed to achieve new desired value
		set_variable = {
			which = {{varname}}_desired_value_delta
			value = {{varname}}_new_desired_value 
		}
		subtract_variable = {
			which = {{varname}}_desired_value_delta
			value = current_{{varname}}_desired_value
		}
		# {{varname}}_desired_value_delta is now the delta between new and old desired point

		# Set desired value to new desired value
		add_resource = {
			{{varname}}_desired_value = 1
			mult = {{varname}}_desired_value_delta
		}

		# Get current value of {{varname}}
		export_resource_stockpile_to_variable = {
			resource = {{varname}}_current_value
			variable = current_{{varname}}_current_value
		}

		set_variable = {
			which = delta_between_current_desired_{{varname}}
			value = {{varname}}_new_desired_value
		}
		subtract_variable = {
			which = delta_between_current_desired_{{varname}}
			value = current_{{varname}}_current_value
		}
		# delta_between_current_desired_{{varname}} now represents the difference between the values

		# If we are close, remove modifiers, if we are far, add trending up or trending down
		if = {
			limit = {
				check_variable = {
					which = delta_between_current_desired_{{varname}}
					value <= 2
				}
				check_variable = {
					which = delta_between_current_desired_{{varname}}
					value >= -2
				}
			}
			remove_modifier = {{varname}}_current_value_trending_up
			remove_modifier = {{varname}}_current_value_trending_down
		}
		else = {
			if = {
				limit = {
					check_variable = {
						which = {{varname}}_new_desired_value
						value >= current_{{varname}}_current_value
					}
				}
				add_modifier = {
					modifier = {{varname}}_current_value_trending_up
					days = -1
				}
			}
			else = {
				add_modifier = {
					modifier = {{varname}}_current_value_trending_down
					days = -1
				}
			}
		}

		# create_message = {
		# 	type = {{varname}}_values_updated
		# 	localization = {{varname}}_values_updated_message
		# 	days = 5
		# 	target = root
		# }
	}	
}
